{% extends 'base.html' %}
{% load static %}
{% load custom_filters1 %}
{% block title %}
    ë¡œê·¸ì¸ | ì§ëŒì´
{% endblock %}
{% block styles %}
<!-- íšŒì›ê°€ì…/ë¡œê·¸ì¸ í˜ì´ì§€ì— ì ìš©ë  CSS ë¶ˆëŸ¬ì˜¤ê¸° -->
<link rel="stylesheet" href="{% static 'auth/css/auth.css' %}">
{% endblock %}

{% block body %}
<div class="root">
    <img src="{% static 'auth/images/auth_mascots.png' %}" alt="Overlay Image" class="overlay-img hidden md:block">
    
    <!-- ë¡œê·¸ì¸ í¼ -->
    <div class="signin-wrapper form {% if mode == 'login' %}active{% endif %}">
        <div class="form-wrapper">
            <h5>ë¡œê·¸ì¸</h5>
            <form method="post" action="?mode=login">
				{% csrf_token %}
				{{ login_form.non_field_errors }}

				{{ login_form.username }}
				{% for error in login_form.username.errors %}
					<p class="text-sm text-red-500 my-1">{{ error }}</p>
				{% endfor %}

				<div class="{% if login_form.password.errors %}border border-red-500 rounded-md{% endif %}">
					{{ login_form.password }}
				</div>
				{% for error in login_form.password.errors %}
					<p class="text-sm text-red-500 my-1">{{ error }}</p>
				{% endfor %}

				<button type="submit" class="button primary my-1">ë¡œê·¸ì¸</button>
            </form>

            <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜: ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°, íšŒì›ê°€ì… ë§í¬ -->
            <div class="my-4 text-sm text-center text-gray-600 space-x-4">
                <a href="#" id="find-id-link" class="hover:underline">ì•„ì´ë”” ì°¾ê¸°</a>
                <span>|</span>
                <a href="#" id="find-password-link" class="hover:underline">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
                <span>|</span>
                <a href="#" id="signup-link" class="hover:underline">íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>

	<!-- íšŒì›ê°€ì… -->
	<div class="signup-wrapper form {% if mode == 'signup' %}active{% endif %}">
		<div class="form-wrapper">
			<h5>íšŒì›ê°€ì…</h5>
			<form method="post" action="?mode=signup" enctype="multipart/form-data">
				{% csrf_token %}
				<!-- ì•„ì´ë”” -->
				<div class="flex flex-col">
					<div class="flex items-center mt-2">
						<input type="text" name="username" id="id_username"
							value="{{ signup_form.username.value|default:'' }}"
							class="form-field"
							placeholder="ì•„ì´ë””">
						<button type="button"
								class="rounded-md text-sm px-2 whitespace-nowrap"
								onclick="checkDuplicate('username')">ì¤‘ë³µí™•ì¸</button>
					</div>
					<p id="username-check-result" class="text-sm"></p>
					{% for error in signup_form.username.errors %}
						<p class="text-sm text-red-500 my-1">{{ error }}</p>
					{% endfor %}
				</div>

				<!-- ë‹‰ë„¤ì„ -->
				<div class="flex flex-col">
					<div class="flex items-center">
						<input type="text" name="nickname" id="id_nickname"
							value="{{ signup_form.nickname.value|default:'' }}"
							class="form-field"
							placeholder="ë‹‰ë„¤ì„">
						<button type="button"
								class="rounded-md text-sm px-2 whitespace-nowrap"
								onclick="checkDuplicate('nickname')">ì¤‘ë³µí™•ì¸</button>
					</div>
					<!-- ì¤‘ë³µí™•ì¸ ê²°ê³¼ ë©”ì‹œì§€ ë°•ìŠ¤ -->
					<p id="nickname-check-result" class="text-sm"></p>

					{% for error in signup_form.nickname.errors %}
						<p class="text-sm text-red-500 my-1">{{ error }}</p>
					{% endfor %}
				</div>


				<!-- ì´ë©”ì¼ -->
				<div class="mb-1">
					<input type="email" name="email"
							value="{{ signup_form.email.value|default:'' }}"
							class="form-field"
							placeholder="ì´ë©”ì¼">
					{% for error in signup_form.email.errors %}
						<p class="text-sm text-red-500 my-1">{{ error }}</p>
					{% endfor %}
				</div>

				<!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
				<div class="flex justify-between">
					<!-- ì»¤ìŠ¤í…€ íŒŒì¼ ì„ íƒ ë ˆì´ì•„ì›ƒ -->
					<div class="items-center flex-wrap my-1">
						<label class="block text-sm text-gray-700">í”„ë¡œí•„ ì´ë¯¸ì§€</label>
						<!-- ì„ íƒëœ íŒŒì¼ëª… í‘œì‹œ ì˜ì—­ -->
						<span id="selectedFileName" class="mr-2 text-sm text-gray-600 truncate max-w-[200px]">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>

						<!-- ì‹¤ì œ íŒŒì¼ input (ìˆ¨ê¹€ ì²˜ë¦¬) -->
						<input type="file" id="imageUpload" name="profile_image" accept="image/*"
						class="hidden">
					</div>
					<!-- íŒŒì¼ ì„ íƒ ë²„íŠ¼ -->
					<label for="imageUpload" class="my-3 px-2 py-1 primary cursor-pointer justify-center rounded-md text-sm transition">
						íŒŒì¼ì„ íƒ
					</label>

					<!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
					{% for error in signup_form.profile_image.errors %}
						<p class="text-sm text-red-500 my-1">{{ error }}</p>
					{% endfor %}
				</div>

				<div class="mb-1">
					<!-- íŒ€ ì„ íƒ -->
					{{ signup_form.team }}
					{% for error in signup_form.team.errors %}
					<p class="text-sm text-red-500 my-1">{{ error }}</p>
					{% endfor %}
				</div>

				<!-- ë¹„ë°€ë²ˆí˜¸ -->
				<input type="password" name="password1" class="form-field" placeholder="ë¹„ë°€ë²ˆí˜¸">
				{% for error in signup_form.password1.errors %}
					<p class="text-sm text-red-500 my-1">{{ error }}</p>
				{% endfor %}

				<input type="password" name="password2" class="form-field" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
				{% for error in signup_form.password2.errors %}
					<p class="text-sm text-red-500 my-1">{{ error }}</p>
				{% endfor %}

				{% for error in signup_form.non_field_errors %}
					<p class="text-sm text-red-500 my-1">{{ error }}</p>
				{% endfor %}

				<button type="submit" class="button primary my-3">íšŒì›ê°€ì…</button>
			</form>

			<div class="text-sm text-center text-gray-600">
				<a href="#" id="signin-link-from-signup" class="hover:underline">ë¡œê·¸ì¸</a>
			</div>
		</div>
	</div>

    <!-- ì•„ì´ë”” ì°¾ê¸° í¼ -->
    <div class="find-id-wrapper form">
        <div class="form-wrapper">
            <h5>ì•„ì´ë”” ì°¾ê¸°</h5>
            <form method="post" id="find-id-form">
                {% csrf_token %}
                <input type="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" class="form-field" required>
                <button type="submit" class="button primary my-1">ì´ë©”ì¼ë¡œ ì•„ì´ë”” ë°›ê¸°</button>
            </form>
            <div id="id-code-result" class="my-2 text-center text-sm text-green-600"></div>

            <div class="text-sm text-center text-gray-600">
                <a href="#" id="signin-link-from-others" class="hover:underline">ë¡œê·¸ì¸</a>
            </div>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í¼: 3ë‹¨ê³„ë¡œ êµ¬ì„± -->
    <div class="find-password-wrapper form">
        <div class="form-wrapper">
            <h5>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h5>

            <!-- 1ë‹¨ê³„: ì•„ì´ë””, ì´ë©”ì¼ ì…ë ¥ -->
            <form method="post" id="find-password-form">
                {% csrf_token %}
                <input type="text" name="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="form-field" required>
                <input type="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" class="form-field" required>
                <button type="submit" class="button primary my-1">ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ ë°›ê¸°</button>
            </form>

            <!-- 2ë‹¨ê³„: ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
            <form method="post" id="verify-code-form" class="my-4 hidden">
                {% csrf_token %}
                <input type="text" name="code" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" class="form-field" required>
                <button type="submit" class="button primary">ì¸ì¦ë²ˆí˜¸ í™•ì¸</button>
            </form>

            <!-- 3ë‹¨ê³„: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • -->
            <form method="post" id="reset-password-form" class="my-4 hidden">
                {% csrf_token %}
                <input type="password" name="new_password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="form-field" required>
                <input type="password" name="confirm_password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="form-field" required>
                <button type="submit" class="button primary">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
            </form>

            <div id="pw-code-result" class="my-2 text-center text-sm text-green-600"></div>

            <div class="text-sm text-center text-gray-600">
                <a href="#" id="signin-link-from-password" class="hover:underline">ë¡œê·¸ì¸</a>
            </div>
        </div>
    </div>

</div>

<script>
	document.getElementById('imageUpload').addEventListener('change', function (e) {
		const fileName = e.target.files[0]?.name || 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
		document.getElementById('selectedFileName').textContent = fileName;
	});
	// ğŸ”¹ ê° í¼ ìš”ì†Œ DOM ì°¸ì¡°
	const signinWrapper = document.querySelector('.signin-wrapper');
	const signupWrapper = document.querySelector('.signup-wrapper');
	const findIdWrapper = document.querySelector('.find-id-wrapper');
	const findPasswordWrapper = document.querySelector('.find-password-wrapper');

	// ğŸ”¹ í¼ ì „í™˜ í•¨ìˆ˜
	const switchForm = (targetWrapper) => {
		[signinWrapper, signupWrapper, findIdWrapper, findPasswordWrapper].forEach(wrapper => {
			wrapper.classList.remove('active');
		});
		targetWrapper.classList.add('active');
	};

	// ğŸ”¹ ë¡œê·¸ì¸ í¼ â†’ ì•„ì´ë””/ë¹„ë²ˆ/íšŒì›ê°€ì…
	document.getElementById('find-id-link').addEventListener('click', e => {
		e.preventDefault();
		switchForm(findIdWrapper);
	});

	document.getElementById('find-password-link').addEventListener('click', e => {
		e.preventDefault();
		switchForm(findPasswordWrapper);
	});

	document.getElementById('signup-link').addEventListener('click', e => {
		e.preventDefault();
		switchForm(signupWrapper);
	});

	// ğŸ”¹ ê¸°íƒ€ í¼ â†’ ë¡œê·¸ì¸ ë³µê·€
	document.getElementById('signin-link-from-signup').addEventListener('click', e => {
		e.preventDefault();
		switchForm(signinWrapper);
	});

	document.getElementById('signin-link-from-others').addEventListener('click', e => {
		e.preventDefault();
		switchForm(signinWrapper);
	});

	document.getElementById('signin-link-from-password').addEventListener('click', e => {
		e.preventDefault();
		switchForm(signinWrapper);
	});

	// ğŸ”¹ ì•„ì´ë”” ì°¾ê¸° - ì´ë©”ì¼ ì „ì†¡
	document.getElementById('find-id-form').addEventListener('submit', function (e) {
		e.preventDefault();

		const email = this.email.value;
		const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

		fetch('/accounts/find_id/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrfToken
			},
			body: JSON.stringify({ email })
		})
			.then(res => res.json())
			.then(data => {
				const resultBox = document.getElementById('id-code-result');
				resultBox.textContent = data.message;
			});
	});

	// ğŸ”¹ fade ì „í™˜ ì• ë‹ˆë©”ì´ì…˜
	function fadeSwitch(fromEl, toEl) {
		fromEl.classList.add('fade-out');
		setTimeout(() => {
			fromEl.classList.add('hidden');
			fromEl.classList.remove('fade-out');
			toEl.classList.remove('hidden');
			toEl.classList.add('fade-in');
			setTimeout(() => toEl.classList.remove('fade-in'), 300);
		}, 300);
	}

	// ğŸ”¹ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°: 3ë‹¨ê³„ ì „ì—­ ë³€ìˆ˜
	let tempUsername = "";

	// ğŸ”¹ step 1: ì¸ì¦ ìš”ì²­
	document.getElementById('find-password-form').addEventListener('submit', function (e) {
		e.preventDefault();

		const email = this.email.value;
		const username = this.username.value;
		const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
		const resultEl = document.getElementById('pw-code-result');

		fetch('/accounts/reset_password/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrfToken
			},
			body: JSON.stringify({ email, username })
		})
			.then(res => res.json())
			.then(data => {
				resultEl.textContent = data.message;
				if (data.success) {
					resultEl.classList.remove('text-red-600');
					resultEl.classList.add('text-green-600');
					tempUsername = username;
					fadeSwitch(this, document.getElementById('verify-code-form'));
				} else {
					resultEl.classList.remove('text-green-600');
					resultEl.classList.add('text-red-600');
				}
			});
	});

	// ğŸ”¹ step 2: ì¸ì¦ë²ˆí˜¸ í™•ì¸
	document.getElementById('verify-code-form').addEventListener('submit', function (e) {
		e.preventDefault();

		const code = this.code.value;
		const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
		const resultEl = document.getElementById('pw-code-result');

		fetch('/accounts/confirm_verification_code/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrfToken
			},
			body: JSON.stringify({ username: tempUsername, code })
		})
			.then(res => res.json())
			.then(data => {
				resultEl.textContent = data.message;
				if (data.success) {
					resultEl.classList.remove('text-red-600');
					resultEl.classList.add('text-green-600');
					fadeSwitch(this, document.getElementById('reset-password-form'));
				} else {
					resultEl.classList.remove('text-green-600');
					resultEl.classList.add('text-red-600');
				}
			});
	});

	// ğŸ”¹ step 3: ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
	document.getElementById('reset-password-form').addEventListener('submit', function (e) {
		e.preventDefault();

		const new_password = this.new_password.value;
		const confirm_password = this.confirm_password.value;
		const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
		const resultEl = document.getElementById('pw-code-result');

		if (new_password !== confirm_password) {
			resultEl.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
			resultEl.classList.remove('text-green-600');
			resultEl.classList.add('text-red-600');
			return;
		}

		fetch('/accounts/set_new_password/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrfToken
			},
			body: JSON.stringify({ username: tempUsername, new_password })
		})
			.then(res => res.json())
			.then(data => {
				resultEl.textContent = data.message;
				if (data.success) {
					resultEl.classList.remove('text-red-600');
					resultEl.classList.add('text-green-600');
				} else {
					resultEl.classList.remove('text-green-600');
					resultEl.classList.add('text-red-600');
				}
			});
	});

	// ğŸ”¹ íšŒì›ê°€ì… ì¤‘ë³µí™•ì¸ (username, nickname)
	function checkDuplicate(field) {
		const signupForm = document.querySelector('.signup-wrapper.form');
		if (!signupForm.classList.contains('active')) return;

		const input = signupForm.querySelector(`[name=${field}]`);
		const resultBox = document.getElementById(`${field}-check-result`);
		const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

		if (!input || !input.value.trim()) {
			resultBox.textContent = `${field}ì„(ë¥¼) ì…ë ¥í•˜ì„¸ìš”.`;
			resultBox.className = 'text-sm text-red-600 my-1';
			return;
		}

		fetch("/accounts/check-duplicate/", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				"X-CSRFToken": csrfToken
			},
			body: JSON.stringify({ field, value: input.value.trim() })
		})
			.then(res => res.json())
			.then(data => {
				resultBox.textContent = data.message;
				resultBox.className = 'text-sm my-1 ' + (data.success ? 'text-green-600' : 'text-red-600');
			});
	}

	document.addEventListener('DOMContentLoaded', function () {
		// ì œëª© ì„¤ì • í•¨ìˆ˜
		function setPageTitle(title) {
			document.title = title;
		}

		// í¼ ìš”ì†Œ
		const signinWrapper = document.querySelector('.signin-wrapper');
		const signupWrapper = document.querySelector('.signup-wrapper');
		const findIdWrapper = document.querySelector('.find-id-wrapper');
		const findPasswordWrapper = document.querySelector('.find-password-wrapper');

		// í¼ ì „í™˜ í•¨ìˆ˜
		const switchForm = (targetWrapper) => {
			[signinWrapper, signupWrapper, findIdWrapper, findPasswordWrapper].forEach(wrapper => {
				wrapper.classList.remove('active');
			});
			targetWrapper.classList.add('active');
		};

		// í´ë¦­ ì´ë²¤íŠ¸ì— ë”°ë¼ í¼ ì „í™˜ + íƒ€ì´í‹€ ë³€ê²½
		document.getElementById('find-id-link').addEventListener('click', e => {
			e.preventDefault();
			switchForm(findIdWrapper);
			setPageTitle('ì•„ì´ë”” ì°¾ê¸° | ì§ëŒì´');
		});

		document.getElementById('find-password-link').addEventListener('click', e => {
			e.preventDefault();
			switchForm(findPasswordWrapper);
			setPageTitle('ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° | ì§ëŒì´');
		});

		document.getElementById('signup-link').addEventListener('click', e => {
			e.preventDefault();
			switchForm(signupWrapper);
			setPageTitle('íšŒì›ê°€ì… | ì§ëŒì´');
		});

		document.getElementById('signin-link-from-signup').addEventListener('click', e => {
			e.preventDefault();
			switchForm(signinWrapper);
			setPageTitle('ë¡œê·¸ì¸ | ì§ëŒì´');
		});

		document.getElementById('signin-link-from-others').addEventListener('click', e => {
			e.preventDefault();
			switchForm(signinWrapper);
			setPageTitle('ë¡œê·¸ì¸ | ì§ëŒì´');
		});

		document.getElementById('signin-link-from-password').addEventListener('click', e => {
			e.preventDefault();
			switchForm(signinWrapper);
			setPageTitle('ë¡œê·¸ì¸ | ì§ëŒì´');
		});
	});
</script>

{% endblock %}
