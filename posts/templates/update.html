{% extends 'base.html' %}
{% load static %}

{% block body %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 font-handdrawn relative z-0">
  <!-- ğŸŸ¡ ë°°ê²½ ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ë“¤ -->
  <img src="{% static 'posts/images/detail/pinkhitter.png' %}" alt="ìŠ¤í‹°ì»¤"
      class="w-36 absolute top-4 left-4 z-0 mt-50">
  <img src="{% static 'posts/images/detail/bluehitter.png' %}" alt="ìŠ¤í‹°ì»¤"
      class="w-36 absolute top-4 right-4 z-0 mt-90 max-sm:hidden">

  <!-- ğŸŸ¢ ë³¸ë¬¸ ë°•ìŠ¤ -->
  <div class="bg-white rounded-2xl px-12 py-10 shadow-xl w-full max-w-6xl z-10 relative">
    <h1 class="text-3xl font-extrabold text-center text-black mb-10 tracking-wider">ê²Œì‹œê¸€ ìˆ˜ì •</h1>

    <form action="" method="POST" enctype="multipart/form-data" class="space-y-6 text-gray-800">
      {% csrf_token %}

      <!-- ğŸ“Œ ì¹´í…Œê³ ë¦¬ / ì œëª© / ë‚´ìš© -->
      <div>{{ form.category }}</div>
      <div>{{ form.title }}</div>
      <div>{{ form.content }}</div>

      <!-- ğŸ“¸ ê¸°ì¡´ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ -->
      <div id="image-container" class="flex gap-4 flex-wrap mb-6">
        {% for img in existing_images %}
          <div class="relative w-24 h-24 image-box">
            <img src="{{ img.image.url }}" class="w-full h-full object-cover rounded">
            <input type="checkbox" name="delete_images" value="{{ img.id }}" class="delete-checkbox hidden" id="checkbox-{{ img.id }}">
            <button type="button" data-id="{{ img.id }}"
                    class="absolute top-0 right-0 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full cursor-pointer delete-btn">
              âœ•
            </button>
          </div>
        {% endfor %}

        <!-- ğŸŒ  ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
        <div id="preview-container" class="flex gap-4 flex-wrap"></div>
      </div>

      <!-- ğŸ“‚ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ -->
      <label for="image-input" class="inline-block px-4 py-2 bg-gray-300 rounded-md text-white cursor-pointer">
        ì´ë¯¸ì§€ ì„ íƒ
      </label>
      <small class="ml-2 text-gray-500" id="file-count-label">0ê°œ íŒŒì¼ ì„ íƒë¨</small>
      <input type="file" name="images" id="image-input" multiple hidden>

      <!-- âœ… ì œì¶œ ë²„íŠ¼ -->
      <div class="text-center mt-8">
        <button type="submit"
                class="rounded-full px-8 py-3 bg-[#9AA6B2] text-white text-lg font-semibold hover:bg-[#BCCCDC] transition duration-200 shadow-md">
          ìˆ˜ì • ì™„ë£Œ
        </button>
      </div>
    </form>
  </div>
</div>

<!-- âœ… JS ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  // âœ… ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
  const input = document.getElementById('image-input');
  const preview = document.getElementById('preview-container');
  const fileCountLabel = document.getElementById('file-count-label');
  let selectedFiles = [];

   // íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateTotalFileCount() {
    const existingImagesCount = document.querySelectorAll('.image-box').length;
    const newImagesCount = document.querySelectorAll('#preview-container > div').length;
    const totalCount = existingImagesCount + newImagesCount;
    fileCountLabel.textContent = `${totalCount}ê°œ íŒŒì¼ ì„ íƒë¨`;
  }

   // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° íŒŒì¼ ê°œìˆ˜ í‘œì‹œ
  document.addEventListener('DOMContentLoaded', function() {
    const existingImagesCount = document.querySelectorAll('.image-box').length;
    fileCountLabel.textContent = `${existingImagesCount}ê°œ íŒŒì¼ ì„ íƒë¨`;
  }); 


  // íŒŒì¼ ì„ íƒ ì‹œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
  input.addEventListener('change', function () {
    const files = Array.from(this.files);
    files.forEach(file => {
      selectedFiles.push(file);

      const reader = new FileReader();
      reader.onload = function (e) {
        const container = document.createElement('div');
        container.className = 'relative w-24 h-24';

        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'w-full h-full object-cover rounded';

        const delBtn = document.createElement('button');
        delBtn.innerHTML = 'âœ•';
        delBtn.className = 'absolute top-0 right-0 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full cursor-pointer';

        // ë¯¸ë¦¬ë³´ê¸° ì‚­ì œ ì²˜ë¦¬
        delBtn.onclick = function (e) {
          e.preventDefault();
          container.remove();
          selectedFiles = selectedFiles.filter(f => f !== file);
          

          // inputì˜ filesë„ ê°±ì‹ 
          const dt = new DataTransfer();
          selectedFiles.forEach(f => dt.items.add(f));
          input.files = dt.files;

          updateTotalFileCount();
        };

        container.appendChild(img);
        container.appendChild(delBtn);
        preview.appendChild(container);
        updateTotalFileCount();
      };
      reader.readAsDataURL(file);
    });

    fileCountLabel.textContent = `${selectedFiles.length}ê°œ íŒŒì¼ ì„ íƒë¨ `;
  });

  // âœ… ê¸°ì¡´ ì´ë¯¸ì§€ âœ• ë²„íŠ¼ ëˆ„ë¥´ë©´ ì‚­ì œ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
  document.addEventListener('DOMContentLoaded', function () {
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const form = document.querySelector('form');

    deleteButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const checkbox = document.getElementById(`checkbox-${id}`);
        if (checkbox) checkbox.checked = true;

        // ì„œë²„ ì „ì†¡ìš© hidden input ìƒì„±
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'delete_images';
        hiddenInput.value = id;
        form.appendChild(hiddenInput);

        // ì´ë¯¸ì§€ UIì—ì„œ ì œê±°
        const box = btn.closest('.image-box');
        if (box) { box.remove();
        updateTotalFileCount();}
      });
    });
  });
</script>
{% endblock %}

    

